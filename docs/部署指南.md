# AI Mover Maker 部署指南

## 方案一：传统服务器部署（推荐）

### 1. 服务器准备

#### 系统要求
- **操作系统**: Ubuntu 20.04+ / CentOS 8+ / Debian 11+
- **Node.js**: 18.17.0+
- **内存**: 最低 2GB，推荐 4GB+
- **存储**: 最低 10GB
- **网络**: 需要访问 Google API（或配置代理）

#### 安装 Node.js
```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# CentOS/RHEL
curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
sudo yum install -y nodejs
```

### 2. 项目部署

#### 上传代码
```bash
# 方式1: 使用 Git
git clone https://github.com/yibele/AIMovieMaker.git
cd AIMovieMaker

# 方式2: 上传压缩包
scp -r ./AIMovieMaker user@server:/path/to/
```

#### 安装依赖
```bash
npm install --production
```

#### 配置环境变量
创建 `.env.local` 文件（或在 Vercel/Railway 中配置环境变量）：
```bash
# Supabase 配置（必需）
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Google API 配置（必需）
NEXT_PUBLIC_DASHSCOPE_API_KEY=your-dashscope-api-key

# Flow API（可选）
FLOW_BEARER_TOKEN=your_bearer_token_here
FLOW_PROJECT_ID=your_project_id_here

# Whisk API（可选）
WHISK_COOKIE_NID=your_nid_cookie
WHISK_COOKIE_SECURE_PSID=your_secure_psid_cookie
WHISK_COOKIE_1PSID=your_1psid_cookie
WHISK_COOKIE_1PSIDCC=your_1psidcc_cookie

# 代理配置（如果需要）
PROXY_HOST=http://your-proxy-host
PROXY_PORT=8080
```

#### 配置 Supabase OAuth 回调地址（重要！）
**这是解决"OAuth 跳转到 localhost"问题的关键步骤：**

1. 登录 [Supabase Dashboard](https://supabase.com/dashboard)
2. 选择你的项目
3. 进入 **Authentication** → **URL Configuration**
4. 在 **Site URL** 中设置：
   ```
   https://your-domain.com
   ```
5. 在 **Redirect URLs** 中添加（支持通配符）：
   ```
   https://your-domain.com/*
   https://your-domain.com/
   http://localhost:3000/*  # 开发环境
   ```
6. 保存配置

**注意**：如果部署在 Vercel，Redirect URLs 应该是：
```
https://your-app.vercel.app/*
https://your-app.vercel.app/
```

#### 构建项目
```bash
npm run build
```

### 3. 使用 PM2 管理进程

#### 安装 PM2
```bash
npm install -g pm2
```

#### 创建 PM2 配置文件 `ecosystem.config.js`：
```javascript
module.exports = {
  apps: [{
    name: 'ai-mover-maker',
    script: 'npm',
    args: 'start',
    cwd: '/path/to/AIMovieMaker',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true
  }]
};
```

#### 启动应用
```bash
# 创建日志目录
mkdir -p logs

# 启动应用
pm2 start ecosystem.config.js

# 查看状态
pm2 status

# 查看日志
pm2 logs

# 设置开机自启
pm2 startup
pm2 save
```

### 4. 配置 Nginx 反向代理

#### 安装 Nginx
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install nginx

# CentOS/RHEL
sudo yum install nginx
```

#### 创建 Nginx 配置 `/etc/nginx/sites-available/ai-mover-maker`：
```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为您的域名或 IP

    # 上传大小限制
    client_max_body_size 50M;

    # 代理到 Next.js
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 静态文件缓存
    location /_next/static/ {
        proxy_pass http://localhost:3000;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }
}
```

#### 启用配置
```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/ai-mover-maker /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
sudo systemctl enable nginx
```

## 方案二：使用 Docker 部署

### 1. 创建 Dockerfile

```dockerfile
FROM node:20-alpine AS base

# 安装依赖阶段
FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm ci --only=production

# 构建阶段
FROM base AS builder
WORKDIR /app
COPY . .
COPY --from=deps /app/node_modules ./node_modules
RUN npm run build

# 运行阶段
FROM base AS runner
WORKDIR /app

ENV NODE_ENV=production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

CMD ["node", "server.js"]
```

### 2. 修改 Next.js 配置

```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  output: 'standalone',
};

module.exports = nextConfig;
```

### 3. 构建和运行 Docker

```bash
# 构建镜像
docker build -t ai-mover-maker .

# 运行容器
docker run -d \
  --name ai-mover-maker \
  -p 3000:3000 \
  --env-file .env.production \
  --restart unless-stopped \
  ai-mover-maker
```

## 方案三：云平台部署

### Vercel 部署（最简单）

#### 1. 通过 Vercel Dashboard 部署（推荐）
1. 访问 [Vercel Dashboard](https://vercel.com/dashboard)
2. 点击 **New Project**
3. 导入你的 GitHub 仓库
4. 配置环境变量（**Environment Variables**）：
   - `NEXT_PUBLIC_SUPABASE_URL`
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
   - `SUPABASE_SERVICE_ROLE_KEY`
   - `NEXT_PUBLIC_DASHSCOPE_API_KEY`
   - 其他必需的 API Key
5. 点击 **Deploy**

#### 2. 通过 CLI 部署
```bash
# 安装 Vercel CLI
npm i -g vercel

# 登录
vercel login

# 部署到预览环境
vercel

# 部署到生产环境
vercel --prod
```

#### 3. 配置 Supabase 回调地址（必须！）
部署完成后，你会得到一个 Vercel 域名（如 `https://your-app.vercel.app`）

**立即配置 Supabase**：
1. 进入 Supabase Dashboard → **Authentication** → **URL Configuration**
2. **Site URL**: `https://your-app.vercel.app`
3. **Redirect URLs**: 
   ```
   https://your-app.vercel.app/*
   https://your-app.vercel.app/
   http://localhost:3000/*
   ```
4. 保存并等待 1-2 分钟生效

**如果使用自定义域名**：
1. 在 Vercel 项目设置中添加自定义域名
2. 同样在 Supabase Redirect URLs 中添加：
   ```
   https://your-custom-domain.com/*
   https://your-custom-domain.com/
   ```

### Railway 部署
1. 连接 GitHub 仓库
2. 自动检测 Next.js 项目
3. 设置环境变量
4. 部署完成

## 安全配置

### 1. 配置 HTTPS（使用 Let's Encrypt）
```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
# 添加: 0 12 * * * /usr/bin/certbot renew --quiet
```

### 2. 配置防火墙
```bash
# Ubuntu UFW
sudo ufw allow ssh
sudo ufw allow 'Nginx Full'
sudo ufw enable

# CentOS firewalld
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

## 监控和维护

### 1. 查看应用状态
```bash
# PM2 状态
pm2 status
pm2 monit

# 查看日志
pm2 logs ai-mover-maker --lines 100

# 重启应用
pm2 restart ai-mover-maker

# 更新应用
git pull
npm install --production
npm run build
pm2 restart ai-mover-maker
```

### 2. 备份数据
```bash
#!/bin/bash
# backup.sh
DATE=$(date +%Y%m%d_%H%M%S)
tar -czf /backup/aimovermaker_$DATE.tar.gz \
  /path/to/AIMovieMaker \
  --exclude=node_modules \
  --exclude=.next
```

### 3. 设置定时备份
```bash
crontab -e
# 添加: 0 2 * * * /path/to/backup.sh
```

## 常见问题

### 0. OAuth 登录跳转到 localhost（重要）
**症状**：部署到生产环境后，Google 登录后跳转到 `http://localhost:3000` 而不是你的域名。

**原因**：Supabase Auth 的回调 URL 没有配置正确。

**解决方案**：
1. 登录 Supabase Dashboard
2. **Authentication** → **URL Configuration**
3. 确保 **Redirect URLs** 包含你的生产域名：
   ```
   https://your-domain.com/*
   https://your-domain.com/
   ```
4. **不要**只配置 localhost，要同时配置生产域名
5. 保存后等待 1-2 分钟生效
6. 清除浏览器缓存并重新测试

**验证方法**：
```bash
# 查看当前 Supabase 配置
curl https://your-project.supabase.co/auth/v1/settings
```

### 1. 端口被占用
```bash
# 查看端口占用
sudo netstat -tulpn | grep :3000

# 杀死进程
sudo kill -9 <PID>
```

### 2. 内存不足
```bash
# 创建 Swap 文件
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

### 3. Google API 访问问题
如果服务器在国内，需要配置代理：
```javascript
// lib/proxy-agent.ts
const proxyUrl = process.env.PROXY_URL;
if (proxyUrl) {
  // 使用代理
}
```

## 性能优化

### 1. 启用 Gzip 压缩
在 Nginx 配置中添加：
```nginx
gzip on;
gzip_types text/plain text/css application/json application/javascript;
```

### 2. 配置 CDN
可以将静态资源上传到 CDN，如：
- 阿里云 OSS
- 腾讯云 COS
- AWS S3

### 3. 使用 Redis 缓存
```bash
npm install redis
```

## 总结

推荐部署顺序：
1. **测试环境**: 使用 Vercel 或 Railway 快速部署
2. **生产环境**: 使用 Docker + PM2 + Nginx
3. **大规模**: 考虑 Kubernetes 部署

记得定期：
- 更新依赖包
- 备份数据
- 监控性能
- 更新安全证书