# Flow API 新增接口使用说明

## 概述

本文档说明新增的 5 个 Flow API 接口的使用方法。所有接口都已实现在 `/app/api/flow/` 目录下。

## 接口列表

### 1. 搜索用户项目列表

**接口地址**: `GET /api/flow/projects/search`

**说明**: 获取用户的所有项目列表

**查询参数**:
```typescript
{
  cookie: string;        // 必需 - 用户的登录 Cookie
  pageSize?: number;     // 可选 - 每页数量，默认 20
  cursor?: string;       // 可选 - 分页游标，默认 null
  proxy?: string;        // 可选 - 代理配置
}
```

**请求示例**:
```javascript
const response = await fetch(
  '/api/flow/projects/search?cookie=YOUR_COOKIE&pageSize=20',
  { method: 'GET' }
);
const data = await response.json();
```

**响应数据**:
```json
{
  "projects": [
    {
      "projectId": "项目ID",
      "projectTitle": "项目标题",
      "thumbnailMediaKey": "缩略图Key",
      "creationTime": "2025-11-08T10:36:14.961216Z",
      "sceneCount": 3,
      "scenes": [...]
    }
  ],
  "cursor": "下一页游标"
}
```

---

### 2. 删除项目

**接口地址**: `POST /api/flow/projects/delete`

**说明**: 删除指定的项目

**请求体**:
```typescript
{
  cookie: string;        // 必需 - 用户的登录 Cookie
  projectId: string;     // 必需 - 要删除的项目 ID
  proxy?: string;        // 可选 - 代理配置
}
```

**请求示例**:
```javascript
const response = await fetch('/api/flow/projects/delete', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    cookie: 'YOUR_COOKIE',
    projectId: 'PROJECT_ID_TO_DELETE'
  })
});
const data = await response.json();
```

**响应数据**:
```json
{
  "success": true,
  "status": 200,
  "statusText": "OK",
  "message": "项目删除成功"
}
```

---

### 3. 搜索项目工作流（图片/视频内容）

**接口地址**: `GET /api/flow/workflows/search`

**说明**: 获取项目中的图片或视频工作流列表

**查询参数**:
```typescript
{
  cookie: string;           // 必需 - 用户的登录 Cookie
  projectId: string;        // 必需 - 项目 ID
  mediaType?: string;       // 可选 - 媒体类型: 'IMAGE' 或 'VIDEO'，默认 'VIDEO'
  pageSize?: number;        // 可选 - 每页数量，默认 4
  cursor?: string;          // 可选 - 分页游标，默认 null
  fetchBookmarked?: string; // 可选 - 是否获取收藏，默认 'false'
  rawQuery?: string;        // 可选 - 搜索关键词，默认空
  proxy?: string;           // 可选 - 代理配置
}
```

**请求示例（获取视频）**:
```javascript
const response = await fetch(
  '/api/flow/workflows/search?cookie=YOUR_COOKIE&projectId=PROJECT_ID&mediaType=VIDEO',
  { method: 'GET' }
);
const data = await response.json();
```

**请求示例（获取图片）**:
```javascript
const response = await fetch(
  '/api/flow/workflows/search?cookie=YOUR_COOKIE&projectId=PROJECT_ID&mediaType=IMAGE',
  { method: 'GET' }
);
const data = await response.json();
```

**响应数据（视频）**:
```json
{
  "workflows": [
    {
      "workflowId": "视频ID",
      "title": "视频标题",
      "createTime": "2025-11-08T10:36:14.961216Z",
      "mediaType": "VIDEO",
      "videoData": {
        "fifeUrl": "视频文件URL",
        "thumbnailUrl": "缩略图URL",
        "prompt": "视频提示词",
        "seed": 123456,
        "model": "veo_3_1_t2v_fast",
        "aspectRatio": "VIDEO_ASPECT_RATIO_LANDSCAPE"
      }
    }
  ],
  "cursor": "下一页游标",
  "mediaType": "MEDIA_TYPE_VIDEO"
}
```

**响应数据（图片）**:
```json
{
  "workflows": [
    {
      "workflowId": "图片ID",
      "title": "图片标题",
      "createTime": "2025-11-08T10:36:14.961216Z",
      "mediaType": "IMAGE",
      "imageData": {
        "fifeUrl": "图片文件URL",
        "prompt": "图片提示词",
        "seed": 123456,
        "model": "GEM_PIX",
        "aspectRatio": "IMAGE_ASPECT_RATIO_LANDSCAPE"
      }
    }
  ],
  "cursor": "下一页游标",
  "mediaType": "MEDIA_TYPE_IMAGE"
}
```

---

### 4. 视频超清放大（1080p）

**接口地址**: `POST /api/flow/video/upsample`

**说明**: 将视频放大至 1080p 超清分辨率

**请求体**:
```typescript
{
  bearerToken: string;   // 必需 - OAuth 2.0 访问令牌
  mediaId: string;       // 必需 - 原始视频的媒体 ID
  sceneId: string;       // 必需 - 场景 ID
  aspectRatio?: string;  // 可选 - 视频比例: '16:9' 或 '9:16'，默认 '16:9'
  sessionId?: string;    // 可选 - 会话 ID
  seed?: number;         // 可选 - 随机种子
  proxy?: string;        // 可选 - 代理配置
}
```

**请求示例**:
```javascript
const response = await fetch('/api/flow/video/upsample', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    bearerToken: 'YOUR_BEARER_TOKEN',
    mediaId: 'VIDEO_MEDIA_ID',
    sceneId: 'SCENE_ID',
    aspectRatio: '16:9'
  })
});
const data = await response.json();
```

**响应数据**:
```json
{
  "operationName": "698f2d752670fc64ebc95841536b660d",
  "sceneId": "5c3248ad-b298-4124-9642-41df0bfdd2b6",
  "status": "MEDIA_GENERATION_STATUS_PENDING",
  "remainingCredits": 360,
  "message": "视频超清任务已创建，请使用 /api/flow/video/status 查询进度"
}
```

**查询超清视频状态**:
```javascript
// 使用返回的 operationName 和 sceneId 查询进度
const statusResponse = await fetch('/api/flow/video/status', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    bearerToken: 'YOUR_BEARER_TOKEN',
    operations: [
      {
        operation: { name: 'OPERATION_NAME' },
        sceneId: 'SCENE_ID',
        status: 'MEDIA_GENERATION_STATUS_PENDING'
      }
    ]
  })
});
const statusData = await statusResponse.json();
```

**状态查询响应（成功）**:
```json
{
  "operations": [
    {
      "operation": {
        "name": "698f2d752670fc64ebc95841536b660d",
        "metadata": {
          "video": {
            "fifeUrl": "https://storage.googleapis.com/.../video_upsampled",
            "servingBaseUri": "https://storage.googleapis.com/.../thumbnail",
            "seed": 922940,
            "model": "veo_2_1080p_upsampler_8s",
            "aspectRatio": "VIDEO_ASPECT_RATIO_LANDSCAPE"
          }
        }
      },
      "sceneId": "5c3248ad-b298-4124-9642-41df0bfdd2b6",
      "status": "MEDIA_GENERATION_STATUS_SUCCESSFUL"
    }
  ],
  "remainingCredits": 360
}
```

---

## 完整使用流程示例

### 场景 1: 获取并删除项目

```javascript
// 1. 获取项目列表
const projectsRes = await fetch('/api/flow/projects/search?cookie=YOUR_COOKIE');
const { projects } = await projectsRes.json();

console.log('项目列表:', projects);

// 2. 删除特定项目
const deleteRes = await fetch('/api/flow/projects/delete', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    cookie: 'YOUR_COOKIE',
    projectId: projects[0].projectId
  })
});

const deleteResult = await deleteRes.json();
console.log('删除结果:', deleteResult);
```

### 场景 2: 查看项目中的视频和图片

```javascript
const projectId = 'YOUR_PROJECT_ID';
const cookie = 'YOUR_COOKIE';

// 获取项目中的视频
const videosRes = await fetch(
  `/api/flow/workflows/search?cookie=${cookie}&projectId=${projectId}&mediaType=VIDEO`
);
const { workflows: videos } = await videosRes.json();

console.log('视频列表:', videos);

// 获取项目中的图片
const imagesRes = await fetch(
  `/api/flow/workflows/search?cookie=${cookie}&projectId=${projectId}&mediaType=IMAGE`
);
const { workflows: images } = await imagesRes.json();

console.log('图片列表:', images);
```

### 场景 3: 视频超清放大

```javascript
const bearerToken = 'YOUR_BEARER_TOKEN';
const mediaId = 'ORIGINAL_VIDEO_MEDIA_ID';
const sceneId = 'SCENE_ID';

// 1. 发起超清任务
const upsampleRes = await fetch('/api/flow/video/upsample', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    bearerToken,
    mediaId,
    sceneId,
    aspectRatio: '16:9'
  })
});

const { operationName, sceneId: returnedSceneId } = await upsampleRes.json();

// 2. 轮询查询状态（每 10 秒查询一次）
async function checkUpsampleStatus() {
  const statusRes = await fetch('/api/flow/video/status', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      bearerToken,
      operations: [{
        operation: { name: operationName },
        sceneId: returnedSceneId,
        status: 'MEDIA_GENERATION_STATUS_PENDING'
      }]
    })
  });

  const { operations } = await statusRes.json();
  const operation = operations[0];

  if (operation.status === 'MEDIA_GENERATION_STATUS_SUCCESSFUL') {
    console.log('超清视频生成成功!');
    console.log('视频URL:', operation.operation.metadata.video.fifeUrl);
    return operation;
  } else if (operation.status === 'MEDIA_GENERATION_STATUS_FAILED') {
    throw new Error('视频超清失败');
  } else {
    console.log('视频生成中...', operation.status);
    // 等待 10 秒后继续查询
    await new Promise(resolve => setTimeout(resolve, 10000));
    return checkUpsampleStatus();
  }
}

const result = await checkUpsampleStatus();
console.log('超清视频结果:', result);
```

---

## 状态码说明

### 视频生成状态
- `MEDIA_GENERATION_STATUS_PENDING` - 等待处理
- `MEDIA_GENERATION_STATUS_ACTIVE` - 处理中
- `MEDIA_GENERATION_STATUS_SUCCESSFUL` - 生成成功
- `MEDIA_GENERATION_STATUS_FAILED` - 生成失败

### 视频比例
- `VIDEO_ASPECT_RATIO_LANDSCAPE` - 横屏（16:9）
- `VIDEO_ASPECT_RATIO_PORTRAIT` - 竖屏（9:16）

### 图片比例
- `IMAGE_ASPECT_RATIO_LANDSCAPE` - 横向（16:9）
- `IMAGE_ASPECT_RATIO_PORTRAIT` - 纵向（9:16）
- `IMAGE_ASPECT_RATIO_SQUARE` - 方形（1:1）

---

## 注意事项

1. **认证方式**:
   - 项目管理接口（搜索/删除项目、工作流）使用 Cookie 认证
   - 媒体生成接口（视频超清）使用 Bearer Token 认证

2. **代理配置**:
   - 所有接口都支持可选的代理参数
   - 代理配置会自动通过 `resolveProxyAgent` 函数处理

3. **异步操作**:
   - 视频超清是异步操作，需要轮询状态接口获取结果
   - 建议每 10 秒查询一次状态

4. **URL 有效期**:
   - 返回的媒体 URL（fifeUrl）包含签名和过期时间
   - 需要及时下载保存，避免链接过期

5. **积分系统**:
   - 视频超清操作会消耗积分
   - 响应中的 `remainingCredits` 表示剩余积分

6. **错误处理**:
   - 所有接口都包含完整的错误处理
   - 错误信息会记录在控制台并返回给客户端

---

## 目录结构

```
app/api/flow/
├── generate/
│   └── route.ts              # 图片生成
├── upload/
│   └── route.ts              # 图片上传
├── video/
│   ├── generate/
│   │   └── route.ts          # 视频生成
│   ├── start-end/
│   │   └── route.ts          # 首尾帧视频生成
│   ├── status/
│   │   └── route.ts          # 视频状态查询
│   └── upsample/
│       └── route.ts          # 视频超清放大 (新增)
├── projects/
│   ├── search/
│   │   └── route.ts          # 搜索项目列表 (新增)
│   └── delete/
│       └── route.ts          # 删除项目 (新增)
└── workflows/
    └── search/
        └── route.ts          # 搜索工作流 (新增)
```

