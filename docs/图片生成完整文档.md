# å›¾ç‰‡ç”Ÿæˆå®Œæ•´è°ƒç”¨æ–‡æ¡£

> **æœ€åæ›´æ–°**: 2024å¹´
> **æŠ€æœ¯æ ˆ**: Google Flow API (Imagen 3.5)
> **æ¶æ„**: å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨ Google APIï¼ˆç»•è¿‡ Vercel æœåŠ¡å™¨ï¼ŒèŠ‚çœæµé‡è´¹ç”¨ï¼‰

---

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
2. [æ–‡ç”Ÿå›¾ (Text to Image)](#æ–‡ç”Ÿå›¾-text-to-image)
3. [å›¾ç”Ÿå›¾ (Image to Image)](#å›¾ç”Ÿå›¾-image-to-image)
4. [å¤šå›¾èåˆ (Multi-image Recipe)](#å¤šå›¾èåˆ-multi-image-recipe)
5. [å›¾ç‰‡ä¸Šä¼ ](#å›¾ç‰‡ä¸Šä¼ )
6. [é…ç½®è¦æ±‚](#é…ç½®è¦æ±‚)
7. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æ¶æ„æ¦‚è§ˆ

### è°ƒç”¨é“¾è·¯

```
UI å±‚ (AIInputPanel / FloatingToolbar)
    â†“
ä¸šåŠ¡é€»è¾‘å±‚ (input-panel-generator.ts)
    â†“
API å°è£…å±‚ (api-mock.ts)
    â†“
ç›´æ¥è°ƒç”¨å±‚ (direct-google-api.ts)
    â†“
Google Flow API (https://aisandbox-pa.googleapis.com)
```

### æ ¸å¿ƒç‰¹ç‚¹

- **ç›´è¿æ¨¡å¼**: å®¢æˆ·ç«¯æµè§ˆå™¨ç›´æ¥è°ƒç”¨ Google APIï¼Œä¸ç»è¿‡ Vercel æœåŠ¡å™¨
- **èŠ‚çœæµé‡**: ä½¿ç”¨ Google CDN çš„ `fifeUrl` è¿”å›å›¾ç‰‡ï¼Œé¿å…ä¼ è¾“å¤§é‡ base64 æ•°æ®
- **ä¿ç•™ base64**: ç”Ÿæˆçš„å›¾ç‰‡ä¿ç•™ base64 æ•°æ®ç”¨äºåç»­ç¼–è¾‘ï¼ˆå¦‚å›¾ç‰‡æ ‡æ³¨ï¼‰
- **æ‰¹é‡ç”Ÿæˆ**: æ”¯æŒä¸€æ¬¡ç”Ÿæˆ 1-4 å¼ å›¾ç‰‡
- **æ¨¡å‹é€‰æ‹©**: æ”¯æŒBanana Pro (GEM_PIX_2) æ¨¡å‹

---

## æ–‡ç”Ÿå›¾ (Text to Image)

### åŠŸèƒ½æè¿°

æ ¹æ®æ–‡å­—æç¤ºè¯ä»é›¶ç”Ÿæˆå›¾ç‰‡ï¼Œä¸ä¾èµ–ä»»ä½•å‚è€ƒå›¾ã€‚

### è°ƒç”¨æµç¨‹

#### 1. UI å±‚è§¦å‘

**ä½ç½®**: `components/AIInputPanel.tsx`

```typescript
// ç”¨æˆ·åœ¨è¾“å…¥æ¡†è¾“å…¥æç¤ºè¯ï¼Œé€‰æ‹©å®½é«˜æ¯”ï¼Œç‚¹å‡»å›è½¦
const handleGenerate = () => {
  if (!prompt.trim()) return;
  
  if (onGenerateFromInput) {
    onGenerateFromInput(prompt, aspectRatio, generationCount, panelRef.current);
    setPrompt(''); // æ¸…ç©ºè¾“å…¥æ¡†
  }
};
```

#### 2. ä¸šåŠ¡é€»è¾‘å±‚

**ä½ç½®**: `lib/input-panel-generator.ts`

```typescript
export async function generateFromInput(
  prompt: string,
  aspectRatio: '16:9' | '9:16' | '1:1',
  count: number,
  position: { x: number; y: number },
  addElement: (el: ImageElement) => void,
  updateElement: (id: string, updates: Partial<ImageElement>) => void,
  deleteElement: (id: string) => void,
  addPromptHistory: (history: any) => void
) {
  // 1. åˆ›å»ºå ä½ç¬¦èŠ‚ç‚¹ï¼ˆç©ºç™½å›¾ç‰‡æ¡†ï¼‰
  const placeholderIds: string[] = [];
  for (let i = 0; i < count; i++) {
    const newImageId = `image-${Date.now()}-${i}`;
    placeholderIds.push(newImageId);
    
    const placeholderImage: ImageElement = {
      id: newImageId,
      type: 'image',
      src: '',
      position: { x: startX + i * (size.width + 20), y: position.y },
      size: size,
      generatedFrom: { type: 'input', prompt: prompt },
    };
    
    addElement(placeholderImage);
  }
  
  // 2. è°ƒç”¨ API ç”Ÿæˆå›¾ç‰‡
  const result = await generateImage(prompt, aspectRatio, count);
  
  // 3. æ›´æ–°å ä½ç¬¦èŠ‚ç‚¹ä¸ºçœŸå®å›¾ç‰‡
  result.images.forEach((img, index) => {
    if (index < placeholderIds.length) {
      updateElement(placeholderIds[index], {
        src: img.imageUrl,          // Google CDN URL
        base64: img.base64,          // ä¿å­˜ base64 ç”¨äºç¼–è¾‘
        promptId: result.promptId,
        mediaId: img.mediaId,
        mediaGenerationId: img.mediaGenerationId,
      });
    }
  });
}
```

#### 3. API å°è£…å±‚

**ä½ç½®**: `lib/api-mock.ts`

```typescript
export async function generateImage(
  prompt: string,
  aspectRatio: '16:9' | '9:16' | '1:1' = '16:9',
  count?: number
): Promise<{
  imageUrl: string;
  promptId: string;
  mediaId?: string;
  mediaGenerationId?: string;
  workflowId?: string;
  translatedPrompt?: string;
  sessionId?: string;
  images?: Array<{
    imageUrl: string;
    base64?: string;
    mediaId?: string;
    mediaGenerationId?: string;
    workflowId?: string;
    prompt?: string;
    seed?: number;
    fifeUrl?: string;
  }>;
}> {
  // è·å–é…ç½®
  const apiConfig = useCanvasStore.getState().apiConfig;
  
  // æ£€æŸ¥å¿…éœ€é…ç½®
  if (!apiConfig.bearerToken || !apiConfig.projectId) {
    throw new Error('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® Bearer Token å’Œ Project ID');
  }
  
  // è·å–ä¼šè¯ ID
  let sessionId = apiConfig.sessionId;
  if (!sessionId) {
    const context = useCanvasStore.getState().regenerateFlowContext();
    sessionId = context.sessionId;
  }
  
  const accountTier = apiConfig.accountTier || 'pro';
  const imageModel = apiConfig.imageModel || 'nanobanana';
  
  // ç›´æ¥è°ƒç”¨ Google API
  const { generateImageDirectly } = await import('./direct-google-api');
  
  const result = await generateImageDirectly(
    prompt,
    apiConfig.bearerToken,
    apiConfig.projectId,
    sessionId,
    aspectRatio,
    accountTier,
    undefined, // references ä¸ºç©ºï¼ˆæ–‡ç”Ÿå›¾ï¼‰
    undefined, // seed
    count ?? apiConfig.generationCount ?? 1,
    useCanvasStore.getState().currentPrefixPrompt,
    imageModel
  );
  
  // è½¬æ¢æ ¼å¼å¹¶è¿”å›
  const images = result.images.map(img => ({
    imageUrl: img.fifeUrl || '',
    base64: img.encodedImage,
    mediaId: img.mediaId,
    mediaGenerationId: img.mediaGenerationId,
    workflowId: img.workflowId,
    prompt: img.prompt,
    seed: img.seed,
    fifeUrl: img.fifeUrl,
  }));
  
  return {
    imageUrl: images[0]?.imageUrl || '',
    promptId: generateId(),
    mediaId: images[0]?.mediaId,
    mediaGenerationId: images[0]?.mediaGenerationId,
    workflowId: images[0]?.workflowId,
    translatedPrompt: images[0]?.prompt,
    sessionId: result.sessionId,
    images,
  };
}
```

#### 4. ç›´æ¥è°ƒç”¨å±‚

**ä½ç½®**: `lib/direct-google-api.ts`

```typescript
export async function generateImageDirectly(
  prompt: string,
  bearerToken: string,
  projectId: string,
  sessionId: string,
  aspectRatio: '16:9' | '9:16' | '1:1',
  accountTier: 'pro' | 'ultra',
  references?: Array<{ mediaId?: string; mediaGenerationId?: string }>,
  seed?: number,
  count?: number,
  prefixPrompt?: string,
  model?: 'nanobanana' | 'nanobananapro'
): Promise<{
  images: Array<{
    encodedImage?: string;
    mediaId?: string;
    mediaGenerationId?: string;
    workflowId?: string;
    prompt?: string;
    seed?: number;
    mimeType?: string;
    fifeUrl?: string;
  }>;
  sessionId: string;
}> {
  // è§„èŒƒåŒ–å®½é«˜æ¯”
  const normalizedAspect = aspectRatio === '9:16'
    ? 'IMAGE_ASPECT_RATIO_PORTRAIT'
    : aspectRatio === '1:1'
    ? 'IMAGE_ASPECT_RATIO_SQUARE'
    : 'IMAGE_ASPECT_RATIO_LANDSCAPE';
  
  const generationCount = Math.max(1, Math.min(4, count || 1));
  
  // é€‰æ‹©æ¨¡å‹
  const imageModelName = model === 'nanobananapro' 
    ? 'GEM_PIX_2' 
    : 'GEM_PIX';
  
  // æ„å»ºæœ€ç»ˆæç¤ºè¯
  const finalPrompt = prefixPrompt && prefixPrompt.trim()
    ? `${prefixPrompt.trim()}, ${prompt}`
    : prompt;
  
  // å¤„ç†å‚è€ƒå›¾ï¼ˆæ–‡ç”Ÿå›¾æ—¶ä¸ºç©ºï¼‰
  const imageInputs = [];
  
  // ç”Ÿæˆå¤šä¸ªè¯·æ±‚
  const requests = Array.from({ length: generationCount }, (_, index) => {
    const requestSeed = typeof seed === 'number'
      ? seed + index
      : Math.floor(Math.random() * 1_000_000);
    
    return {
      clientContext: { sessionId: sessionId.trim() },
      seed: requestSeed,
      imageModelName: imageModelName,
      imageAspectRatio: normalizedAspect,
      prompt: finalPrompt,
      imageInputs, // ç©ºæ•°ç»„
    };
  });
  
  const payload = { requests };
  
  // è°ƒç”¨ Google API
  const response = await fetch(
    `https://aisandbox-pa.googleapis.com/v1/projects/${projectId.trim()}/flowMedia:batchGenerateImages`,
    {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${bearerToken}`,
      },
      body: JSON.stringify(payload),
    }
  );
  
  if (!response.ok) {
    throw new Error(`Generate failed: ${response.status}`);
  }
  
  const rawData = await response.json();
  
  // è§£æå“åº”
  const mediaArray = Array.isArray(rawData) ? rawData : rawData?.media || [];
  
  const normalizedImages = mediaArray
    .map((entry: any) => {
      const generatedImage = entry?.generatedImage || entry?.image?.generatedImage || entry?.image;
      if (!generatedImage) return null;
      
      const encodedImage = generatedImage?.encodedImage || generatedImage?.base64Image;
      const fifeUrl = generatedImage?.fifeUrl;
      
      if (!fifeUrl && !encodedImage) return null;
      
      return {
        encodedImage,
        mediaId: entry?.mediaId || generatedImage?.mediaId,
        mediaGenerationId: generatedImage?.mediaGenerationId,
        workflowId: entry?.workflowId || generatedImage?.workflowId,
        prompt: generatedImage?.prompt || finalPrompt,
        seed: generatedImage?.seed,
        mimeType: generatedImage?.mimeType || 'image/png',
        fifeUrl,
      };
    })
    .filter(Boolean);
  
  return {
    images: normalizedImages,
    sessionId: sessionId.trim(),
  };
}
```

### API ç«¯ç‚¹

```
POST https://aisandbox-pa.googleapis.com/v1/projects/{projectId}/flowMedia:batchGenerateImages
```

### è¯·æ±‚æ ¼å¼

```json
{
  "requests": [
    {
      "clientContext": {
        "sessionId": ";1732000000000"
      },
      "seed": 123456,
      "imageModelName": "GEM_PIX",
      "imageAspectRatio": "IMAGE_ASPECT_RATIO_LANDSCAPE",
      "prompt": "a beautiful sunset over mountains",
      "imageInputs": []
    }
  ]
}
```

### å“åº”æ ¼å¼

```json
{
  "media": [
    {
      "mediaId": "projects/xxx/media/yyy",
      "workflowId": "workflow-uuid",
      "image": {
        "generatedImage": {
          "encodedImage": "base64...",
          "fifeUrl": "https://lh3.googleusercontent.com/...",
          "mediaGenerationId": "CAMaJGM2...",
          "mimeType": "image/png",
          "prompt": "a beautiful sunset over mountains",
          "seed": 123456
        }
      }
    }
  ]
}
```

### å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| `prompt` | string | âœ… | å›¾ç‰‡ç”Ÿæˆæç¤ºè¯ |
| `aspectRatio` | '16:9' \| '9:16' \| '1:1' | âœ… | å®½é«˜æ¯” |
| `count` | number | âŒ | ç”Ÿæˆæ•°é‡ï¼Œé»˜è®¤ 1ï¼Œæœ€å¤§ 4 |
| `bearerToken` | string | âœ… | Google API è®¤è¯ Token |
| `projectId` | string | âœ… | Google Flow Project ID |
| `sessionId` | string | âœ… | ä¼šè¯ IDï¼Œæ ¼å¼å¦‚ `;1732000000000` |
| `accountTier` | 'pro' \| 'ultra' | âŒ | è´¦å·ç±»å‹ï¼Œé»˜è®¤ 'pro' |
| `imageModel` | 'nanobanana' \| 'nanobananapro' | âŒ | æ¨¡å‹é€‰æ‹©ï¼Œé»˜è®¤ 'nanobanana' (GEM_PIX) |
| `prefixPrompt` | string | âŒ | å‰ç½®æç¤ºè¯ï¼Œä¼šè‡ªåŠ¨æ‹¼æ¥åˆ° prompt å‰é¢ |
| `seed` | number | âŒ | éšæœºç§å­ï¼Œç”¨äºå¤ç°å›¾ç‰‡ |

---

## å›¾ç”Ÿå›¾ (Image to Image)

### åŠŸèƒ½æè¿°

åŸºäºä¸€å¼ å·²æœ‰å›¾ç‰‡è¿›è¡Œç¼–è¾‘æˆ–å˜ä½“ç”Ÿæˆã€‚åŒ…æ‹¬ä¸¤ä¸ªä½¿ç”¨åœºæ™¯ï¼š
1. **FloatingToolbar** - å›¾ç‰‡ç¼–è¾‘ï¼ˆæ ‡æ³¨åå›¾ç”Ÿå›¾ï¼‰
2. **AIInputPanel** - é€‰ä¸­ä¸€å¼ å›¾ç‰‡åè¾“å…¥æç¤ºè¯

### è°ƒç”¨æµç¨‹

#### åœºæ™¯ 1: å›¾ç‰‡ç¼–è¾‘ï¼ˆFloatingToolbarï¼‰

**è§¦å‘ç‚¹**: ç”¨æˆ·ç‚¹å‡» FloatingToolbar çš„"å›¾ç‰‡ç¼–è¾‘"æŒ‰é’®

```typescript
// components/FloatingToolbar.tsx

// 1. æ‰“å¼€å›¾ç‰‡æ ‡æ³¨å·¥å…·
const handleAnnotate = async () => {
  if (!selectedImage?.src) {
    toast.error('å½“å‰å›¾ç‰‡æš‚æ— å¯ç¼–è¾‘å†…å®¹');
    return;
  }
  
  // åŠ è½½å›¾ç‰‡çš„ base64 æ•°æ®
  // å¦‚æœå›¾ç‰‡å·²æœ‰ base64ï¼Œç›´æ¥ä½¿ç”¨
  if (selectedImage.base64) {
    setAnnotatorTarget({
      ...selectedImage,
      src: `data:image/png;base64,${selectedImage.base64}`,
    });
    return;
  }
  
  // å¦‚æœæ²¡æœ‰ base64ï¼Œé€šè¿‡ API è·å–åŸå›¾
  const effectiveMediaId = selectedImage.mediaId || selectedImage.mediaGenerationId;
  const mediaResponse = await fetch(
    `/api/flow/media/${effectiveMediaId}?key=${apiConfig.apiKey}&returnUriOnly=false`
  );
  const mediaData = await mediaResponse.json();
  const encodedImage = mediaData?.image?.encodedImage;
  
  setAnnotatorTarget({
    ...selectedImage,
    src: `data:image/png;base64,${encodedImage}`,
  });
};

// 2. ç”¨æˆ·åœ¨ ImageAnnotatorModal ä¸­æ ‡æ³¨å›¾ç‰‡å¹¶è¾“å…¥æç¤ºè¯

// 3. ç¡®è®¤æ ‡æ³¨åè°ƒç”¨å›¾ç”Ÿå›¾
const handleAnnotatorConfirm = async (result: ImageAnnotatorResult, annotatedImageDataUrl: string) => {
  if (!selectedImage || !result.promptText.trim()) return;
  
  try {
    // 3.1 å°†æ ‡æ³¨åçš„å›¾ç‰‡è½¬ä¸º base64
    const base64Data = annotatedImageDataUrl.split(',')[1];
    
    // 3.2 ä¸Šä¼ æ ‡æ³¨å›¾ç‰‡åˆ° Flowï¼Œè·å– mediaGenerationId
    const { registerUploadedImage } = await import('@/lib/api-mock');
    const uploadResult = await registerUploadedImage(base64Data);
    
    if (!uploadResult.mediaGenerationId) {
      throw new Error('ä¸Šä¼ å¤±è´¥ï¼šæœªè·å–åˆ° mediaGenerationId');
    }
    
    // 3.3 è°ƒç”¨å›¾ç”Ÿå›¾ API
    const { imageToImage } = await import('@/lib/api-mock');
    const imageResult = await imageToImage(
      result.promptText,
      annotatedImageDataUrl,
      aspectRatio,
      '',
      uploadResult.mediaGenerationId,
      1
    );
    
    // 3.4 åˆ›å»ºæ–°å›¾ç‰‡èŠ‚ç‚¹
    const newImageId = `image-${Date.now()}`;
    const newImage: ImageElement = {
      id: newImageId,
      type: 'image',
      src: imageResult.imageUrl,
      base64: imageResult.images?.[0]?.base64,
      position: newPosition,
      size: size,
      sourceImageIds: [selectedImage.id],
      generatedFrom: {
        type: 'image-to-image',
        sourceIds: [selectedImage.id],
        prompt: result.promptText,
      },
    };
    
    addElement(newImage);
  } catch (error) {
    console.error('âŒ å›¾ç‰‡ç¼–è¾‘å¤±è´¥:', error);
  }
};
```

#### åœºæ™¯ 2: AIInputPanel å›¾ç”Ÿå›¾

**è§¦å‘ç‚¹**: ç”¨æˆ·é€‰ä¸­ä¸€å¼ å›¾ç‰‡åï¼Œåœ¨è¾“å…¥æ¡†è¾“å…¥æç¤ºè¯

```typescript
// lib/input-panel-generator.ts

export async function imageToImageFromInput(
  prompt: string,
  aspectRatio: '16:9' | '9:16' | '1:1',
  count: number,
  selectedImage: ImageElement,
  addElement: (el: ImageElement) => void,
  updateElement: (id: string, updates: Partial<ImageElement>) => void,
  deleteElement: (id: string) => void,
  addPromptHistory: (history: any) => void,
  setEdges: any
) {
  // 1. åˆ›å»ºå ä½ç¬¦èŠ‚ç‚¹å’Œè¿çº¿
  const placeholderIds: string[] = [];
  for (let i = 0; i < count; i++) {
    const newImageId = `image-${Date.now()}-${i}`;
    placeholderIds.push(newImageId);
    
    addElement({
      id: newImageId,
      type: 'image',
      src: '',
      position: { x: selectedImage.position.x + 700, y: selectedImage.position.y },
      size: size,
      sourceImageIds: [selectedImage.id],
      generatedFrom: {
        type: 'image-to-image',
        sourceIds: [selectedImage.id],
        prompt: prompt,
      },
    });
    
    // åˆ›å»ºè¿çº¿
    setEdges((eds: any) => [
      ...eds,
      {
        id: `edge-${selectedImage.id}-${newImageId}`,
        source: selectedImage.id,
        target: newImageId,
        animated: true,
      },
    ]);
  }
  
  // 2. æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰ mediaId
  let effectiveMediaId = selectedImage.mediaId || selectedImage.mediaGenerationId;
  
  if (!effectiveMediaId) {
    // å¦‚æœæ²¡æœ‰ï¼Œéœ€è¦å…ˆä¸Šä¼ å›¾ç‰‡
    const imageDataToUpload = selectedImage.base64 || selectedImage.src;
    const { registerUploadedImage } = await import('./api-mock');
    const uploadResult = await registerUploadedImage(imageDataToUpload);
    effectiveMediaId = uploadResult.mediaGenerationId;
  }
  
  // 3. è°ƒç”¨å›¾ç”Ÿå›¾ API
  const result = await imageToImage(
    prompt,
    selectedImage.src,
    aspectRatio,
    '',
    effectiveMediaId,
    count
  );
  
  // 4. æ›´æ–°å ä½ç¬¦èŠ‚ç‚¹
  result.images.forEach((img, index) => {
    if (index < placeholderIds.length) {
      updateElement(placeholderIds[index], {
        src: img.imageUrl,
        base64: img.base64,
        promptId: result.promptId,
        mediaId: img.mediaId,
        mediaGenerationId: img.mediaGenerationId,
      });
    }
  });
  
  // 5. åœæ­¢è¿çº¿åŠ¨ç”»
  setEdges((eds: any) =>
    eds.map((edge: any) =>
      edge.animated ? { ...edge, animated: false } : edge
    )
  );
}
```

#### API å°è£…å±‚

**ä½ç½®**: `lib/api-mock.ts`

```typescript
export async function imageToImage(
  prompt: string,
  sourceImageUrl: string,
  aspectRatio: '16:9' | '9:16' | '1:1' = '16:9',
  caption: string = '',
  originalMediaId?: string,
  count?: number
): Promise<{
  imageUrl: string;
  promptId: string;
  mediaId?: string;
  mediaGenerationId?: string;
  workflowId?: string;
  translatedPrompt?: string;
  images?: Array<{...}>;
}> {
  const apiConfig = useCanvasStore.getState().apiConfig;
  
  // æ£€æŸ¥é…ç½®
  if (!apiConfig.bearerToken || !apiConfig.projectId) {
    throw new Error('å›¾ç”Ÿå›¾éœ€è¦é…ç½® Bearer Token å’Œ Project ID');
  }
  
  if (!originalMediaId || !originalMediaId.trim()) {
    throw new Error('å›¾ç”Ÿå›¾éœ€è¦æä¾›åŸå§‹å›¾ç‰‡çš„ mediaId æˆ– mediaGenerationId');
  }
  
  let sessionId = apiConfig.sessionId;
  if (!sessionId) {
    const context = useCanvasStore.getState().regenerateFlowContext();
    sessionId = context.sessionId;
  }
  
  const accountTier = apiConfig.accountTier || 'pro';
  const imageModel = apiConfig.imageModel || 'nanobanana';
  
  // ç›´æ¥è°ƒç”¨ Google API
  const { generateImageDirectly } = await import('./direct-google-api');
  
  const result = await generateImageDirectly(
    prompt,
    apiConfig.bearerToken,
    apiConfig.projectId,
    sessionId,
    aspectRatio,
    accountTier,
    [{ mediaId: originalMediaId }], // ä¼ å…¥å‚è€ƒå›¾
    undefined, // seed
    count || 1,
    useCanvasStore.getState().currentPrefixPrompt,
    imageModel
  );
  
  // è½¬æ¢æ ¼å¼å¹¶è¿”å›
  const images = result.images.map(img => ({
    imageUrl: img.fifeUrl || '',
    base64: img.encodedImage,
    mediaId: img.mediaId,
    mediaGenerationId: img.mediaGenerationId,
    workflowId: img.workflowId,
    prompt: img.prompt,
    seed: img.seed,
    fifeUrl: img.fifeUrl,
  }));
  
  return {
    imageUrl: images[0]?.imageUrl || '',
    promptId: generateId(),
    mediaId: images[0]?.mediaId,
    mediaGenerationId: images[0]?.mediaGenerationId,
    workflowId: images[0]?.workflowId,
    translatedPrompt: images[0]?.prompt,
    images,
  };
}
```

### API ç«¯ç‚¹

ä¸æ–‡ç”Ÿå›¾ç›¸åŒï¼š
```
POST https://aisandbox-pa.googleapis.com/v1/projects/{projectId}/flowMedia:batchGenerateImages
```

### è¯·æ±‚æ ¼å¼ï¼ˆå›¾ç”Ÿå›¾ï¼‰

```json
{
  "requests": [
    {
      "clientContext": {
        "sessionId": ";1732000000000"
      },
      "seed": 123456,
      "imageModelName": "GEM_PIX",
      "imageAspectRatio": "IMAGE_ASPECT_RATIO_LANDSCAPE",
      "prompt": "add a rainbow in the sky",
      "imageInputs": [
        {
          "name": "projects/xxx/media/yyy",
          "imageInputType": "IMAGE_INPUT_TYPE_REFERENCE"
        }
      ]
    }
  ]
}
```

**å…³é”®åŒºåˆ«**: `imageInputs` æ•°ç»„åŒ…å«å‚è€ƒå›¾çš„ `mediaId`ã€‚

---

## å¤šå›¾èåˆ (Multi-image Recipe)

### åŠŸèƒ½æè¿°

åŸºäºå¤šå¼ å›¾ç‰‡è¿›è¡Œèåˆç¼–è¾‘ï¼Œå¯ä»¥å°†å¤šå¼ å›¾ç‰‡çš„å…ƒç´ ç»„åˆæˆæ–°å›¾ç‰‡ã€‚

### ä½¿ç”¨åœºæ™¯

- åœ¨ AIInputPanel ä¸­é€‰ä¸­å¤šå¼ å›¾ç‰‡ï¼ˆ2å¼ åŠä»¥ä¸Šï¼‰
- è¾“å…¥æç¤ºè¯æè¿°å¦‚ä½•èåˆè¿™äº›å›¾ç‰‡
- ä¾‹å¦‚ï¼š"å°†å›¾ç‰‡1çš„äººç‰©æ”¾åˆ°å›¾ç‰‡2çš„èƒŒæ™¯ä¸­"

### è°ƒç”¨æµç¨‹

**ä½ç½®**: `lib/input-panel-generator.ts`

```typescript
export async function multiImageRecipeFromInput(
  prompt: string,
  aspectRatio: '16:9' | '9:16' | '1:1',
  count: number,
  selectedImages: ImageElement[],
  addElement: (el: ImageElement) => void,
  updateElement: (id: string, updates: Partial<ImageElement>) => void,
  deleteElement: (id: string) => void,
  addPromptHistory: (history: any) => void,
  setEdges: any
) {
  // 1. æ£€æŸ¥æ‰€æœ‰å›¾ç‰‡æ˜¯å¦æœ‰ mediaGenerationId
  const missingIds = selectedImages.filter(
    (img) => !img.mediaGenerationId || !img.mediaGenerationId.trim()
  );
  if (missingIds.length > 0) {
    throw new Error('å­˜åœ¨æœªåŒæ­¥åˆ° Flow çš„å›¾ç‰‡ï¼Œæ— æ³•è¿›è¡Œå¤šå›¾ç¼–è¾‘');
  }
  
  // 2. æ„å»ºå‚è€ƒå›¾åˆ—è¡¨
  const references = selectedImages.map((img) => ({
    mediaGenerationId: img.mediaGenerationId as string,
    caption: img.caption || img.generatedFrom?.prompt || `Reference image ${img.id}`,
    mediaCategory: 'MEDIA_CATEGORY_SUBJECT',
  }));
  
  // 3. åˆ›å»ºå ä½ç¬¦èŠ‚ç‚¹
  const baseImage = selectedImages[0];
  const placeholderIds: string[] = [];
  
  for (let i = 0; i < count; i++) {
    const newImageId = `image-${Date.now()}-${i}`;
    placeholderIds.push(newImageId);
    
    addElement({
      id: newImageId,
      type: 'image',
      src: '',
      position: { x: baseImage.position.x + 700, y: baseImage.position.y },
      size,
      sourceImageIds: selectedImages.map((img) => img.id),
      generatedFrom: {
        type: 'image-to-image',
        sourceIds: selectedImages.map((img) => img.id),
        prompt: prompt,
      },
    });
    
    // ä¸ºæ¯ä¸ªæºå›¾ç‰‡åˆ›å»ºè¿çº¿
    selectedImages.forEach((sourceImg) => {
      setEdges((eds: any) => [
        ...eds,
        {
          id: `edge-${sourceImg.id}-${newImageId}`,
          source: sourceImg.id,
          target: newImageId,
          animated: true,
        },
      ]);
    });
  }
  
  // 4. è°ƒç”¨å¤šå›¾èåˆ API
  const result = await runImageRecipe(
    prompt,
    references,
    aspectRatio,
    undefined,
    count
  );
  
  // 5. æ›´æ–°å ä½ç¬¦èŠ‚ç‚¹
  result.images.forEach((img, index) => {
    if (index < placeholderIds.length) {
      updateElement(placeholderIds[index], {
        src: img.imageUrl,
        base64: img.base64,
        promptId: result.promptId,
        mediaId: img.mediaId,
        mediaGenerationId: img.mediaGenerationId,
      });
    }
  });
  
  // 6. åœæ­¢è¿çº¿åŠ¨ç”»
  setEdges((eds: any) =>
    eds.map((edge: any) =>
      edge.animated ? { ...edge, animated: false } : edge
    )
  );
}
```

### API å°è£…å±‚

**ä½ç½®**: `lib/api-mock.ts`

```typescript
export async function runImageRecipe(
  instruction: string,
  referenceImages: Array<{
    mediaId?: string;
    mediaGenerationId?: string;
    caption?: string;
    mediaCategory?: string;
  }>,
  aspectRatio: '16:9' | '9:16' | '1:1' = '16:9',
  seed?: number,
  count?: number
): Promise<{
  imageUrl: string;
  promptId: string;
  mediaId?: string;
  mediaGenerationId?: string;
  workflowId?: string;
  translatedPrompt?: string;
  images?: Array<{...}>;
}> {
  const apiConfig = useCanvasStore.getState().apiConfig;
  
  // æ£€æŸ¥é…ç½®
  if (!apiConfig.bearerToken || !apiConfig.projectId) {
    throw new Error('å¤šå›¾ç¼–è¾‘éœ€è¦é…ç½® Bearer Token å’Œ Project ID');
  }
  
  // æ„å»ºæœ‰æ•ˆçš„å‚è€ƒå›¾åˆ—è¡¨
  const validReferences = referenceImages
    .filter((ref) => 
      (ref.mediaId && ref.mediaId.trim()) || 
      (ref.mediaGenerationId && ref.mediaGenerationId.trim())
    )
    .map((ref) => ({
      mediaId: ref.mediaId || ref.mediaGenerationId,
    }));
  
  if (validReferences.length < 2) {
    throw new Error('è‡³å°‘éœ€è¦ä¸¤å¼ åŒ…å« mediaId æˆ– mediaGenerationId çš„å›¾ç‰‡æ‰èƒ½è¿›è¡Œå¤šå›¾ç¼–è¾‘');
  }
  
  let sessionId = apiConfig.sessionId;
  if (!sessionId) {
    const context = useCanvasStore.getState().regenerateFlowContext();
    sessionId = context.sessionId;
  }
  
  const accountTier = apiConfig.accountTier || 'pro';
  const imageModel = apiConfig.imageModel || 'nanobanana';
  
  // ç›´æ¥è°ƒç”¨ Google API
  const { generateImageDirectly } = await import('./direct-google-api');
  
  const result = await generateImageDirectly(
    instruction,
    apiConfig.bearerToken,
    apiConfig.projectId,
    sessionId,
    aspectRatio,
    accountTier,
    validReferences, // ä¼ å…¥å¤šä¸ªå‚è€ƒå›¾
    seed,
    count || 1,
    useCanvasStore.getState().currentPrefixPrompt,
    imageModel
  );
  
  // è½¬æ¢æ ¼å¼å¹¶è¿”å›
  const images = result.images.map(img => ({
    imageUrl: img.fifeUrl || '',
    base64: img.encodedImage,
    mediaId: img.mediaId,
    mediaGenerationId: img.mediaGenerationId,
    workflowId: img.workflowId,
    prompt: img.prompt,
    seed: img.seed,
    fifeUrl: img.fifeUrl,
  }));
  
  return {
    imageUrl: images[0]?.imageUrl || '',
    promptId: generateId(),
    mediaId: images[0]?.mediaId,
    mediaGenerationId: images[0]?.mediaGenerationId,
    workflowId: images[0]?.workflowId,
    translatedPrompt: images[0]?.prompt,
    images,
  };
}
```

### API ç«¯ç‚¹

ä¸æ–‡ç”Ÿå›¾ã€å›¾ç”Ÿå›¾ç›¸åŒï¼š
```
POST https://aisandbox-pa.googleapis.com/v1/projects/{projectId}/flowMedia:batchGenerateImages
```

### è¯·æ±‚æ ¼å¼ï¼ˆå¤šå›¾èåˆï¼‰

```json
{
  "requests": [
    {
      "clientContext": {
        "sessionId": ";1732000000000"
      },
      "seed": 123456,
      "imageModelName": "GEM_PIX",
      "imageAspectRatio": "IMAGE_ASPECT_RATIO_LANDSCAPE",
      "prompt": "combine the person from image 1 with the background from image 2",
      "imageInputs": [
        {
          "name": "projects/xxx/media/yyy",
          "imageInputType": "IMAGE_INPUT_TYPE_REFERENCE"
        },
        {
          "name": "projects/xxx/media/zzz",
          "imageInputType": "IMAGE_INPUT_TYPE_REFERENCE"
        }
      ]
    }
  ]
}
```

**å…³é”®åŒºåˆ«**: `imageInputs` æ•°ç»„åŒ…å«å¤šä¸ªå‚è€ƒå›¾ï¼ˆè‡³å°‘2å¼ ï¼‰ã€‚

---

## å›¾ç‰‡ä¸Šä¼ 

### åŠŸèƒ½æè¿°

å°†æœ¬åœ°å›¾ç‰‡æˆ–æ ‡æ³¨åçš„å›¾ç‰‡ä¸Šä¼ åˆ° Google Flowï¼Œè·å– `mediaGenerationId` ä¾›åç»­ä½¿ç”¨ã€‚

### ä½¿ç”¨åœºæ™¯

1. ç”¨æˆ·ä»æœ¬åœ°ä¸Šä¼ å›¾ç‰‡åˆ°ç”»å¸ƒ
2. å›¾ç‰‡ç¼–è¾‘ï¼ˆæ ‡æ³¨ï¼‰åéœ€è¦ä¸Šä¼ æ ‡æ³¨å›¾
3. å›¾ç”Ÿå›¾å‰æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰ `mediaId`

### è°ƒç”¨æµç¨‹

**ä½ç½®**: `lib/api-mock.ts`

```typescript
export async function registerUploadedImage(
  imageBase64: string,
  flowAspectRatio?: FlowAspectRatioEnum
): Promise<{
  caption: string;
  mediaGenerationId?: string | null;
  workflowId: string;
  sessionId: string;
}> {
  const apiConfig = useCanvasStore.getState().apiConfig;
  
  // æ£€æŸ¥é…ç½®
  if (!apiConfig.bearerToken || !apiConfig.projectId) {
    throw new Error('ä¸Šä¼ å›¾ç‰‡éœ€è¦é…ç½® Bearer Token å’Œ Project ID');
  }
  
  let sessionId = apiConfig.sessionId;
  if (!sessionId) {
    const context = useCanvasStore.getState().regenerateFlowContext();
    sessionId = context.sessionId;
  }
  
  // è½¬æ¢å®½é«˜æ¯”ç±»å‹
  const convertedAspectRatio =
    flowAspectRatio === 'IMAGE_ASPECT_RATIO_PORTRAIT' ? '9:16' :
    flowAspectRatio === 'IMAGE_ASPECT_RATIO_SQUARE' ? '1:1' :
    flowAspectRatio === 'IMAGE_ASPECT_RATIO_LANDSCAPE' ? '16:9' :
    undefined;
  
  // ç›´æ¥è°ƒç”¨ Google API
  const { uploadImageDirectly } = await import('./direct-google-api');
  
  const uploadResult = await uploadImageDirectly(
    imageBase64,
    apiConfig.bearerToken,
    sessionId,
    convertedAspectRatio
  );
  
  const finalWorkflowId = uploadResult.workflowId || apiConfig.workflowId || '';
  const finalSessionId = uploadResult.sessionId || sessionId;
  
  return {
    caption: 'Flow Uploaded Image',
    mediaGenerationId: uploadResult.mediaGenerationId,
    workflowId: finalWorkflowId,
    sessionId: finalSessionId,
  };
}
```

### ç›´æ¥è°ƒç”¨å±‚

**ä½ç½®**: `lib/direct-google-api.ts`

```typescript
export async function uploadImageDirectly(
  imageBase64: string,
  bearerToken: string,
  sessionId: string,
  aspectRatio?: '16:9' | '9:16' | '1:1'
): Promise<{
  mediaGenerationId?: string;
  width?: number;
  height?: number;
  workflowId?: string;
  sessionId: string;
}> {
  // å¤„ç† base64 æ•°æ®
  let base64Data = imageBase64.trim();
  let mimeType = 'image/jpeg';
  
  const dataUrlMatch = base64Data.match(/^data:(.*?);base64,(.*)$/);
  if (dataUrlMatch) {
    mimeType = dataUrlMatch[1] || mimeType;
    base64Data = dataUrlMatch[2];
  }
  
  const sanitizedBase64 = base64Data.replace(/\s/g, '');
  
  // è§„èŒƒåŒ–å®½é«˜æ¯”
  const normalizedAspectRatio = aspectRatio === '9:16' 
    ? 'IMAGE_ASPECT_RATIO_PORTRAIT'
    : aspectRatio === '1:1'
    ? 'IMAGE_ASPECT_RATIO_SQUARE'
    : 'IMAGE_ASPECT_RATIO_LANDSCAPE';
  
  const payload = {
    imageInput: {
      rawImageBytes: sanitizedBase64,
      mimeType,
      isUserUploaded: true,
      aspectRatio: normalizedAspectRatio,
    },
    clientContext: {
      sessionId: sessionId.trim(),
      tool: 'ASSET_MANAGER',
    },
  };
  
  const response = await fetch('https://aisandbox-pa.googleapis.com/v1:uploadUserImage', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${bearerToken}`,
    },
    body: JSON.stringify(payload),
  });
  
  if (!response.ok) {
    throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
  }
  
  const data = await response.json();
  
  return {
    mediaGenerationId: data?.mediaGenerationId?.mediaGenerationId,
    width: data?.width,
    height: data?.height,
    workflowId: data?.workflowId,
    sessionId: sessionId.trim(),
  };
}
```

### API ç«¯ç‚¹

```
POST https://aisandbox-pa.googleapis.com/v1:uploadUserImage
```

### è¯·æ±‚æ ¼å¼

```json
{
  "imageInput": {
    "rawImageBytes": "iVBORw0KGgoAAAANSUhEUgAA...",
    "mimeType": "image/png",
    "isUserUploaded": true,
    "aspectRatio": "IMAGE_ASPECT_RATIO_LANDSCAPE"
  },
  "clientContext": {
    "sessionId": ";1732000000000",
    "tool": "ASSET_MANAGER"
  }
}
```

### å“åº”æ ¼å¼

```json
{
  "mediaGenerationId": {
    "mediaGenerationId": "CAMaJGM2ZTk0ZTRhLTQ3MDQtNDEzYS05MDcwLWMyMmU4NGY5NDVhYyIDQ0FJKiQzM2IxMDlmYy1jYjEzLTQxNzktYTNjZC03MGRiOTViNjFlMDg"
  },
  "width": 1024,
  "height": 576,
  "workflowId": "c6e94e4a-4704-413a-9070-c22e84f945ac"
}
```

---

## é…ç½®è¦æ±‚

### å¿…éœ€é…ç½®

åœ¨å³ä¸Šè§’è®¾ç½®é¢æ¿ä¸­é…ç½®ä»¥ä¸‹å‚æ•°ï¼š

| é…ç½®é¡¹ | è¯´æ˜ | è·å–æ–¹å¼ |
|--------|------|----------|
| **Bearer Token** | Google API è®¤è¯ä»¤ç‰Œ | ä» Google Labs ç½‘ç«™çš„ Network è¯·æ±‚ä¸­æå– |
| **Project ID** | Flow é¡¹ç›® ID | ä» Google Labs ç½‘ç«™çš„ Network è¯·æ±‚ä¸­æå– |
| **Session ID** | ä¼šè¯ ID | è‡ªåŠ¨ç”Ÿæˆï¼Œæ ¼å¼å¦‚ `;1732000000000` |

### å¯é€‰é…ç½®

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| **Account Tier** | `pro` | è´¦å·ç±»å‹ï¼š`pro` æˆ– `ultra` |
| **Image Model** | `nanobanana` | å›¾ç‰‡æ¨¡å‹ï¼š`nanobanana` (GEM_PIX) æˆ– `nanobananapro` (GEM_PIX_2) |
| **Generation Count** | `1` | é»˜è®¤ç”Ÿæˆæ•°é‡ï¼ˆ1-4ï¼‰ |
| **Prefix Prompt** | `` | å‰ç½®æç¤ºè¯ï¼Œä¼šè‡ªåŠ¨æ‹¼æ¥åˆ°æ‰€æœ‰æç¤ºè¯å‰é¢ |

### é…ç½®å­˜å‚¨

é…ç½®å­˜å‚¨åœ¨ Zustand store ä¸­ï¼š

```typescript
// lib/store.ts

interface ApiConfig {
  bearerToken?: string;
  apiKey?: string;
  projectId?: string;
  sessionId?: string;
  workflowId?: string;
  proxy?: string;
  accountTier?: 'pro' | 'ultra';
  imageModel?: 'nanobanana' | 'nanobananapro';
  generationCount?: number;
}

const useCanvasStore = create<CanvasState>((set, get) => ({
  apiConfig: {},
  setApiConfig: (updates: Partial<ApiConfig>) =>
    set((state) => ({
      apiConfig: { ...state.apiConfig, ...updates },
    })),
  // ...
}));
```

---

## å¸¸è§é—®é¢˜

### Q1: å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œæç¤º "è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® Bearer Token"

**åŸå› **: æœªé…ç½® Bearer Token æˆ– Project ID

**è§£å†³æ–¹æ¡ˆ**:
1. æ‰“å¼€å³ä¸Šè§’è®¾ç½®é¢æ¿
2. ä» Google Labs ç½‘ç«™è·å– Bearer Token å’Œ Project ID
3. å¡«å…¥è®¾ç½®å¹¶ä¿å­˜

### Q2: å›¾ç”Ÿå›¾å¤±è´¥ï¼Œæç¤º "å›¾ç”Ÿå›¾éœ€è¦æä¾›åŸå§‹å›¾ç‰‡çš„ mediaId"

**åŸå› **: å›¾ç‰‡æ²¡æœ‰ `mediaId` æˆ– `mediaGenerationId`

**è§£å†³æ–¹æ¡ˆ**:
- **AI ç”Ÿæˆçš„å›¾ç‰‡**: è‡ªåŠ¨åŒ…å« `mediaId`ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨
- **æœ¬åœ°ä¸Šä¼ çš„å›¾ç‰‡**: ç³»ç»Ÿä¼šè‡ªåŠ¨ä¸Šä¼ è·å– `mediaId`
- **å¦‚æœä»ç„¶å¤±è´¥**: æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰ `base64` æ•°æ®ç”¨äºä¸Šä¼ 

### Q3: å¤šå›¾èåˆå¤±è´¥ï¼Œæç¤º "è‡³å°‘éœ€è¦ä¸¤å¼ åŒ…å« mediaId çš„å›¾ç‰‡"

**åŸå› **: é€‰ä¸­çš„å›¾ç‰‡ä¸­æœ‰äº›æ²¡æœ‰ `mediaId`

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®ä¿é€‰ä¸­çš„æ‰€æœ‰å›¾ç‰‡éƒ½æ˜¯ AI ç”Ÿæˆçš„ï¼ˆè‡ªå¸¦ `mediaId`ï¼‰
2. æˆ–è€…ç­‰å¾…æœ¬åœ°ä¸Šä¼ çš„å›¾ç‰‡å®ŒæˆåŒæ­¥ï¼ˆè·å– `mediaId`ï¼‰
3. è‡³å°‘éœ€è¦é€‰ä¸­ 2 å¼ å›¾ç‰‡æ‰èƒ½è¿›è¡Œå¤šå›¾èåˆ

### Q4: ä¸ºä»€ä¹ˆæœ‰äº›å›¾ç‰‡æ˜¾ç¤ºåŠ è½½ä¸­ï¼ˆç°è‰²å ä½ç¬¦ï¼‰ï¼Ÿ

**åŸå› **: å›¾ç‰‡æ­£åœ¨ç”Ÿæˆæˆ–ä¸Šä¼ ä¸­

**è¯´æ˜**:
- **å ä½ç¬¦èŠ‚ç‚¹**: å›¾ç‰‡ç”Ÿæˆå‰ä¼šå…ˆåˆ›å»ºç©ºç™½å ä½ç¬¦
- **åŠ è½½åŠ¨ç”»**: å ä½ç¬¦æ˜¾ç¤ºå‘¼å¸åŠ¨ç”»ï¼Œè¡¨ç¤ºæ­£åœ¨ç”Ÿæˆ
- **è‡ªåŠ¨æ›´æ–°**: ç”Ÿæˆå®Œæˆåè‡ªåŠ¨æ›¿æ¢ä¸ºçœŸå®å›¾ç‰‡

### Q5: å›¾ç‰‡ä¸‹è½½æ—¶å¾ˆæ…¢ï¼Œèƒ½å¦åŠ é€Ÿï¼Ÿ

**åŸå› **: ä½¿ç”¨ Google CDN çš„ `fifeUrl` å¯èƒ½å—ç½‘ç»œå½±å“

**ä¼˜åŒ–æ–¹æ¡ˆ**:
- **ä¼˜å…ˆä½¿ç”¨ base64**: ä¸‹è½½åŠŸèƒ½ä¼šä¼˜å…ˆä½¿ç”¨å›¾ç‰‡è‡ªå¸¦çš„ base64 æ•°æ®ï¼ˆç¬æ—¶ä¸‹è½½ï¼Œ0 ç½‘ç»œæµé‡ï¼‰
- **é™çº§åˆ° URL**: å¦‚æœæ²¡æœ‰ base64ï¼Œæ‰ä¼šä» `fifeUrl` ä¸‹è½½

### Q6: å¦‚ä½•åˆ‡æ¢å›¾ç‰‡æ¨¡å‹ï¼Ÿ

**æ“ä½œæ­¥éª¤**:
1. åœ¨ AIInputPanel åº•éƒ¨æ‰¾åˆ°"æ¨¡å‹"é€‰æ‹©å™¨
2. ç‚¹å‡»åˆ‡æ¢ï¼š
   - **Banana (Preview)**: æ ‡å‡†æ¨¡å‹ GEM_PIX
   - **Banana Pro**: æ–°æ¨¡å‹ GEM_PIX_2ï¼ˆæ¸å˜æŒ‰é’®ï¼Œå³ä¸Šè§’æœ‰çº¢ç‚¹æ ‡è®°ï¼‰

### Q7: Session ID æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•ç”Ÿæˆï¼Ÿ

**è¯´æ˜**: Session ID ç”¨äºæ ‡è¯†ä¸€ä¸ªç”Ÿæˆä¼šè¯ï¼Œæ ¼å¼å¦‚ `;1732000000000`

**ç”Ÿæˆé€»è¾‘**:
```typescript
// lib/store.ts
regenerateFlowContext: () => {
  const newSessionId = `;${Date.now()}`;
  const newWorkflowId = crypto.randomUUID();
  
  set((state) => ({
    apiConfig: {
      ...state.apiConfig,
      sessionId: newSessionId,
      workflowId: newWorkflowId,
    },
  }));
  
  return { sessionId: newSessionId, workflowId: newWorkflowId };
}
```

### Q8: å‰ç½®æç¤ºè¯ï¼ˆPrefix Promptï¼‰æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

**è¯´æ˜**: å‰ç½®æç¤ºè¯ä¼šè‡ªåŠ¨æ‹¼æ¥åˆ°æ‰€æœ‰æç¤ºè¯å‰é¢ï¼Œç”¨äºç»Ÿä¸€é£æ ¼

**ä½¿ç”¨åœºæ™¯**:
- ç»Ÿä¸€è‰ºæœ¯é£æ ¼ï¼š"digital art, trending on artstation"
- ç»Ÿä¸€è´¨é‡è¦æ±‚ï¼š"high quality, 4k, detailed"
- ç»Ÿä¸€ç”»é¢æ•ˆæœï¼š"cinematic lighting, vibrant colors"

**ç¤ºä¾‹**:
- å‰ç½®æç¤ºè¯: `"high quality, detailed, "`
- ç”¨æˆ·è¾“å…¥: `"a cat on the beach"`
- æœ€ç»ˆæç¤ºè¯: `"high quality, detailed, a cat on the beach"`

---

## æŠ€æœ¯æ¶æ„ä¼˜åŠ¿

### 1. ç›´è¿æ¨¡å¼

- âœ… å®¢æˆ·ç«¯æµè§ˆå™¨ç›´æ¥è°ƒç”¨ Google API
- âœ… ä¸ç»è¿‡ Vercel æœåŠ¡å™¨ï¼Œé¿å…æœåŠ¡å™¨å¸¦å®½è´¹ç”¨
- âœ… å‡å°‘å»¶è¿Ÿï¼Œæé«˜å“åº”é€Ÿåº¦

### 2. æµé‡ä¼˜åŒ–

- âœ… ä½¿ç”¨ Google CDN çš„ `fifeUrl` è¿”å›å›¾ç‰‡
- âœ… é¿å…ä¼ è¾“å¤§é‡ base64 æ•°æ®åˆ° Vercel
- âœ… èŠ‚çœ Fast Origin Transfer è´¹ç”¨

### 3. ç¼–è¾‘å‹å¥½

- âœ… ç”Ÿæˆçš„å›¾ç‰‡ä¿ç•™ base64 æ•°æ®
- âœ… ç”¨äºåç»­å›¾ç‰‡ç¼–è¾‘ï¼ˆæ ‡æ³¨ã€æ¶‚æŠ¹ï¼‰
- âœ… æ— éœ€é‡å¤ä¸‹è½½åŸå›¾

### 4. æ‰¹é‡ç”Ÿæˆ

- âœ… æ”¯æŒä¸€æ¬¡ç”Ÿæˆ 1-4 å¼ å›¾ç‰‡
- âœ… ä½¿ç”¨ä¸åŒçš„éšæœºç§å­ï¼ˆseedï¼‰
- âœ… æé«˜åˆ›ä½œæ•ˆç‡

### 5. çµæ´»æ¨¡å‹

- âœ… æ”¯æŒ Banana (Preview) å’Œ Banana Pro ä¸¤ç§æ¨¡å‹
- âœ… å¯æ ¹æ®éœ€æ±‚é€‰æ‹©é€Ÿåº¦æˆ–è´¨é‡
- âœ… Banana Pro (GEM_PIX_2) è´¨é‡æ›´é«˜

---

## æœªæ¥æ‰©å±•

### Whisk API é›†æˆ

ç›®å‰é¡¹ç›®ä¸­å­˜åœ¨ Whisk API çš„ä»£ç ä½†æœªä½¿ç”¨ï¼š
- `/app/api/whisk/edit/route.ts` - Whisk ç¼–è¾‘æ¥å£
- `docs/å¤šå›¾ç¼–è¾‘.md` - Whisk å¤šå›¾ç¼–è¾‘æ–‡æ¡£

**Whisk API ç‰¹ç‚¹**:
- æ”¯æŒ `recipeMediaInputs` æ¨¡å¼
- å¯ä»¥ä¸ºæ¯å¼ å‚è€ƒå›¾æŒ‡å®šè§’è‰²ï¼ˆSUBJECTã€SCENEã€STYLEï¼‰
- æ›´ç²¾ç»†çš„å¤šå›¾æ§åˆ¶

**æœªæ¥å¯èƒ½çš„é›†æˆ**:
```typescript
// Whisk API å¤šå›¾ç¼–è¾‘è¯·æ±‚ç¤ºä¾‹
{
  "userInstruction": "æ¢èƒŒæ™¯",
  "recipeMediaInputs": [
    {
      "caption": "å…”å­å›¾ç‰‡æè¿°...",
      "mediaInput": {
        "mediaCategory": "MEDIA_CATEGORY_SUBJECT",
        "mediaGenerationId": "..."
      }
    },
    {
      "caption": "æµ·æ»©å›¾ç‰‡æè¿°...",
      "mediaInput": {
        "mediaCategory": "MEDIA_CATEGORY_SCENE",
        "mediaGenerationId": "..."
      }
    }
  ]
}
```

---

## ç»“è¯­

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº† AIMovieMaker é¡¹ç›®ä¸­å›¾ç‰‡ç”Ÿæˆçš„å®Œæ•´è°ƒç”¨é€»è¾‘ï¼ŒåŒ…æ‹¬ï¼š

1. **æ–‡ç”Ÿå›¾** - ä»æ–‡å­—æç¤ºè¯ç”Ÿæˆå›¾ç‰‡
2. **å›¾ç”Ÿå›¾** - åŸºäºå·²æœ‰å›¾ç‰‡è¿›è¡Œç¼–è¾‘æˆ–å˜ä½“
3. **å¤šå›¾èåˆ** - å°†å¤šå¼ å›¾ç‰‡çš„å…ƒç´ ç»„åˆæˆæ–°å›¾ç‰‡
4. **å›¾ç‰‡ä¸Šä¼ ** - å°†æœ¬åœ°å›¾ç‰‡ä¸Šä¼ åˆ° Google Flow

æ‰€æœ‰åŠŸèƒ½éƒ½åŸºäº **Google Flow API (Imagen 3.5)**ï¼Œé€šè¿‡å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨å®ç°ï¼Œæ— éœ€ç»è¿‡æœåŠ¡å™¨ä¸­è½¬ï¼Œå¤§å¹…é™ä½äº†æˆæœ¬å¹¶æé«˜äº†å“åº”é€Ÿåº¦ã€‚

å¦‚æœ‰ç–‘é—®æˆ–éœ€è¦è¡¥å……ï¼Œè¯·å‚è€ƒä»£ç å®ç°æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚

